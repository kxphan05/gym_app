<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Critique AI</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --card: #ffffff;
        }
        body { font-family: system-ui, sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 40px; }
        .card { background: var(--card); padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); width: 100%; max-width: 600px; }
        h1 { margin-top: 0; color: #1e293b; font-size: 1.5rem; }
        
        .upload-area { border: 2px dashed #cbd5e1; padding: 2rem; text-align: center; border-radius: 8px; margin-bottom: 1.5rem; cursor: pointer; }
        .upload-area:hover { border-color: var(--primary); background: #eff6ff; }
        
        button { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; width: 100%; }
        button:disabled { background: #94a3b8; cursor: not-allowed; }

        #status { margin-top: 1.5rem; text-align: center; color: #64748b; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; }
        
        #result { margin-top: 2rem; border-top: 1px solid #e2e8f0; padding-top: 1.5rem; display: none; }
        .critique-box { background: #f1f5f9; padding: 1rem; border-radius: 8px; white-space: pre-wrap; font-size: 0.95rem; line-height: 1.5; color: #334155; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="card">
    <h1>Exercise Form Critique</h1>
    <p>Upload your video for a biomechanical analysis.</p>
    
    <form id="uploadForm">
        <div class="upload-area" onclick="document.getElementById('videoFile').click()">
            <input type="file" id="videoFile" accept="video/mp4,video/x-m4v,video/*" style="display:none">
            <span id="fileName">Click to select .mp4 video</span>
        </div>
        <button type="submit" id="submitBtn">Analyze Form</button>
    </form>

    <div id="status" style="display:none">
        <div class="loader"></div> <span id="statusText">Processing movement data...</span>
    </div>

    <div id="result">
        <h3 style="margin-top:0">Critique Result</h3>
        <div id="critiqueContent" class="critique-box"></div>
    </div>
</div>

<script>
    const uploadForm = document.getElementById('uploadForm');
    const videoFile = document.getElementById('videoFile');
    const fileNameDisplay = document.getElementById('fileName');
    const statusDiv = document.getElementById('status');
    const statusText = document.getElementById('statusText');
    const submitBtn = document.getElementById('submitBtn');
    const resultDiv = document.getElementById('result');
    const critiqueContent = document.getElementById('critiqueContent');

    // Display selected filename
    videoFile.onchange = () => {
        if (videoFile.files.length > 0) {
            fileNameDisplay.innerText = videoFile.files[0].name;
        }
    };

    uploadForm.onsubmit = async (e) => {
        e.preventDefault();
        
        if (!videoFile.files[0]) {
            alert("Please select a video first.");
            return;
        }

        const formData = new FormData();
        formData.append('file', videoFile.files[0]);

        // UI State: Loading
        submitBtn.disabled = true;
        statusDiv.style.display = 'block';
        resultDiv.style.display = 'none';
        statusText.innerText = "Analyzing video with MediaPipe & Ollama...";

        try {
            const response = await fetch('/upload-and-critique', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error('Analysis failed.');

            const data = await response.json();
            
            // UI State: Success
            renderResult(data);
        } catch (error) {
            alert("Error: " + error.message);
        } finally {
            submitBtn.disabled = false;
            statusDiv.style.display = 'none';
        }
    };

    function renderResult(data) {
        resultDiv.style.display = 'block';
        
        // If Ollama returns a JSON object, stringify it nicely. 
        // If it's a string, display directly.
        if (typeof data === 'object') {
            critiqueContent.innerText = JSON.stringify(data, null, 2);
        } else {
            critiqueContent.innerText = data;
        }
    }
</script>

</body>
</html>